#!/usr/bin/env perl

use strict;
use warnings;

use Data::Dumper;

use Cwd qw/abs_path getcwd/;
use File::Basename;
use Module::ScanDeps;

my $file;
for my $arg ( @ARGV ) {
    if ( -e $arg ) {
        $file = $arg;
    }
}

my $context = {
    cwd             => getcwd,
    file            => $file,
    file_abs_path   => abs_path( $file ),
    dir_abs_path    => dirname( abs_path( $file )),
    remote          => undef,
    args            => [ @ARGV ],
    debug           => 0,
};

if ( ! -e $context->{ file } ) {
    die "Input script $context->{ file } does not exists\n";
}

chdir $context->{ dir_abs_path };
$context->{ git_tree } = `git rev-parse --show-toplevel`;
chomp $context->{ git_tree };
chdir $context->{ cwd };

die "The command $file is not on a git_tree\n" if $?;

open my $fh, "<", "$ENV{ HOME }/.rperl_remote";  # data point
    $context->{ remote } = <$fh>;
close $fh;

die "There is no remote configured, please run rperl_host!\n" if ! $context->{ remote };

# For the first time sync, after followup the changed files
print "Prepare for: $context->{ file } from $context->{ cwd } @ $context->{ remote }\n";

my $remote_dir = dirname $context->{ git_tree };

my $r_mkdir = `ssh $context->{ remote } mkdir -p $remote_dir`;

my $sync_cmd = "rsync --cvs-exclude -a $context->{ git_tree } $context->{ remote }:$remote_dir";
my $sync = qx/$sync_cmd/;
print $sync_cmd, "\n";
if ( $? ) {
    die "$?\nError when syncing $context->{ remote }:$context->{ git_tree }\n";
}else{
    print "Syncronized $context->{ remote }:$context->{ git_tree }\n";
}

my @cmd = (
    'ssh', $context->{ remote }, 
    'echo -n "Remote Shell PID:";',
    'echo $$;', 
    "export PERL5LIB=$context->{ git_tree }/lib;", 
    'cd', "$context->{ cwd };", 
    'perl', @ARGV, ';', 
    'pgrep -P $$;'
    );

exec @cmd;


